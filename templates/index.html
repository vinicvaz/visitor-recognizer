{% extends "base.html" %} {% block title %}Visitor Recognizer{% endblock %} {%
    block content%}
<div class="container-fluid">

    <video autoplay="true" class="video-element" id="videoElement"></video>

</div>

<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"
    integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>

<script async src="static/js/opencv.js" onload="onOpenCvReady();"></script>

<script type="text/javascript">
    function onOpenCvReady() {
        cv['onRuntimeInitialized'] = () => {
            var socket = io('http://localhost:5000');

            socket.on('connect', function () {
                console.log("Connected...!", socket.connected)
            });

            const video = document.querySelector("#videoElement");

            video.width = 500;
            video.height = 400;

            if (navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function (stream) {
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch(function (err0r) {
                        console.log(err0r)
                        console.log("Something went wrong!");
                    });
            }
            console.log(video)

            var socket = io();
            let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
            let cap = new cv.VideoCapture(video);

            const FPS = 30;
            function processVideo() {

                let begin = Date.now();
                cap.read(src);
                handle_socket(src['data']);
                // schedule next one.
                let delay = 1000 / FPS - (Date.now() - begin);
                setTimeout(processVideo, delay);
            }
            // schedule first one.
            setTimeout(processVideo, 0);

            function handle_socket(src) {

                socket.emit('event', { info: 'I\'m connected!', data: src });

            }



        }
    }
</script>


{% endblock %}